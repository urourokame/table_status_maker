<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>空席メーカーVer.2</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; text-align: center; background: #222; color: #fff; margin: 0; padding: 10px; }
        .map-container { display: grid; gap: 8px; margin: 10px auto; background: #333; padding: 15px; border-radius: 15px; width: fit-content; min-width: 280px; }
        .table { aspect-ratio: 1/1; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 11px; background: #444; color: #888; min-width: 65px; border: 2px solid transparent; }
        .active-table { background: #e8f5e9; color: #2e7d32; }
        .active-table.occupied { background: #ffebee; color: #c62828; }
        .is-counter { border-color: #fb8c00; }
        
        /* 管理画面スタイル */
        .admin-box { background: #333; border: 2px solid #ffeb3b; padding: 15px; margin: 15px 0; border-radius: 10px; display: none; text-align: left; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .admin-box input[type="file"] { width: 100%; font-size: 11px; margin: 5px 0;}
        .grid-config { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #555; font-size: 13px; }
        .table-edit-grid { display: grid; gap: 5px; margin-top: 10px; }
        .edit-cell { background: #444; padding: 5px; border-radius: 5px; font-size: 10px; display: flex; flex-direction: column; align-items: center;}
        .edit-cell input { width: 85%; margin: 2px 0; background: #222; color: #fff; border: 1px solid #666; text-align: center; }
        
        /* ラベルとチェックボックスの密着 */
        .admin-status-row { display: flex; justify-content: center; gap: 2px; width: 100%; margin-top: 3px; }
        .admin-status-row label { display: flex; align-items: center; font-size: 9px; cursor: pointer; white-space: nowrap; }
        .admin-status-row input[type="checkbox"] { margin: 0 2px 0 0; width: 13px; height: 13px; }

        .color-selector { display: flex; justify-content: center; flex-wrap: wrap; gap: 8px; margin: 15px 0; }
        .color-dot { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; border: 2px solid #fff; }
        
        .controls { display: flex; flex-direction: column; gap: 10px; align-items: center; }
        button { padding: 15px 30px; font-size: 18px; font-weight: bold; width: 85%; cursor: pointer; border: none; border-radius: 50px; }
        .btn-gen { background: #00c853; color: white; }
        .btn-close { background: #3f51b5; color: white; font-size: 14px; padding: 10px; }
        .btn-reset { background: #d32f2f; color: white; font-size: 14px; padding: 10px; margin-top: 10px; width: 100%; border-radius: 10px; }

        #resultImage { margin-top: 20px; width: 100%; max-width: 300px; border-radius: 15px; display: none; border: 2px solid #555; }
        canvas { display: none; }
        .secret-trigger { display: inline-block; cursor: default; -webkit-user-select: none; user-select: none; }
    </style>
</head>
<body>

    <h3 id="uiTitle" style="margin-bottom:5px;">空席<span id="adminTrigger" class="secret-trigger">メ</span>イカーVer.2</h3>
    <div style="font-size: 10px; color: #666; margin-bottom: 10px;">背景画像のみ毎日選んでください</div>
    
    <div class="map-container" id="map"></div>

    <div id="adminBox" class="admin-box">
        <div style="font-weight:bold; color:#ffeb3b; margin-bottom:10px; display:flex; justify-content:space-between;">
            <span>【管理者メニュー】</span>
            <button onclick="toggleAdmin()" style="width:auto; padding:2px 10px; font-size:10px; background:#666;">閉じる</button>
        </div>
        
        <div class="grid-config">
            ロゴ登録: <input type="file" id="logoInput" accept="image/*"><br>
            横列: <input type="number" id="gridCols" style="width:35px"> 
            縦行: <input type="number" id="gridRows" style="width:35px">
            <button onclick="updateGridSize()" style="width:auto; font-size:10px; padding:3px 8px; background:#2196f3; color:#fff; border-radius:3px;">適用</button>
        </div>

        <div id="tableEditGrid" class="table-edit-grid"></div>
        
        <button onclick="saveLayout()" style="background:#ff9800; color:white; font-size:14px; padding:12px; margin-top:15px; border-radius:10px; width:100%;">設定を保存して終了</button>
    </div>

    <div class="color-selector">
        <div class="color-dot" style="background:#00c853" onclick="setTheme('#00c853')"></div>
        <div class="color-dot" style="background:#ff80ab" onclick="setTheme('#ff80ab')"></div>
        <div class="color-dot" style="background:#29b6f6" onclick="setTheme('#29b6f6')"></div>
        <div class="color-dot" style="background:#ff9100" onclick="setTheme('#ff9100')"></div>
        <div class="color-dot" style="background:#ffd700" onclick="setTheme('#ffd700')"></div>
        <div class="color-dot" style="background:#9c27b0" onclick="setTheme('#9c27b0')"></div>
        <div class="color-dot" style="background:#eeeeee" onclick="setTheme('#eeeeee')"></div>
    </div>

    <div class="controls">
        <button class="btn-gen" id="genBtn" onclick="generateImage(false)">画像を生成する</button>
	<div style="display:flex; gap:10px; width:85%;">
        <button onclick="generateImage('full')" style="background:#ff5252; color:white; font-size:14px; padding:10px; flex:1; border-radius:50px;">満席スタート</button>
        <button onclick="generateImage('reserved')" style="background:#fb8c00; color:white; font-size:14px; padding:10px; flex:1; border-radius:50px;">本日貸切</button>
    </div>
        <button class="btn-close" onclick="generateImage('closed')">本日の営業を終了する</button>
        <button class="btn-reset" onclick="resetAll()">本日のデータをリセット</button>
        <div style="font-size:12px; margin-top:5px;">背景写真を選択：<input type="file" id="bgInput" accept="image/*" style="width:150px"></div>
    </div>

    <div id="outputArea"><img id="resultImage" alt="生成画像"></div>
    <canvas id="mainCanvas" width="1080" height="1920"></canvas>

    <script>
        let config = JSON.parse(localStorage.getItem('sys_config_v4')) || {
            cols: 3, rows: 3,
            tables: Array(9).fill().map((_, i) => ({ name: `席${i+1}`, seats: 4, active: true, isCounter: false }))
        };
	const FIXED_BRAND = "不自由"
        let occupiedTables = new Set(JSON.parse(localStorage.getItem('occupied') || "[]"));
        let history = JSON.parse(localStorage.getItem('history') || "[]");
        let userBgImage = null, logoImage = null, themeColor = localStorage.getItem('themeColor') || '#00c853';

        let clickCount = 0;
        document.getElementById('adminTrigger').onclick = () => {
            clickCount++;
            if (clickCount >= 7) { toggleAdmin(); clickCount = 0; }
            setTimeout(() => { clickCount = 0; }, 3000);
        };

        function toggleAdmin() {
            const box = document.getElementById('adminBox');
            box.style.display = box.style.display === 'block' ? 'none' : 'block';
            if(box.style.display === 'block') {
                document.getElementById('gridCols').value = config.cols;
                document.getElementById('gridRows').value = config.rows;
                renderAdminGrid();
            }
        }

        function updateGridSize() {
            const c = parseInt(document.getElementById('gridCols').value), r = parseInt(document.getElementById('gridRows').value);
            const newTables = [];
            for(let i=0; i<c*r; i++) newTables.push(config.tables[i] || { name: `席${i+1}`, seats: 4, active: true, isCounter: false });
            config.cols = c; config.rows = r; config.tables = newTables; renderAdminGrid();
        }

        function renderAdminGrid() {
            const container = document.getElementById('tableEditGrid');
            container.style.gridTemplateColumns = `repeat(${config.cols}, 1fr)`;
            container.innerHTML = '';
            config.tables.forEach((t, i) => {
                const cell = document.createElement('div');
                cell.className = 'edit-cell';
                cell.innerHTML = `
                    <input type="text" id="name_${i}" value="${t.name}">
                    <input type="number" id="seats_${i}" value="${t.seats}">
                    <div class="admin-status-row">
                        <label><input type="checkbox" id="active_${i}" ${t.active ? 'checked' : ''}>使用</label>
                        <label><input type="checkbox" id="counter_${i}" ${t.isCounter ? 'checked' : ''}>カウンター</label>
                    </div>`;
                container.appendChild(cell);
            });
        }

        function saveLayout() {
            config.tables.forEach((t, i) => {
                t.name = document.getElementById(`name_${i}`).value;
                t.seats = parseInt(document.getElementById(`seats_${i}`).value);
                t.active = document.getElementById(`active_${i}`).checked;
                t.isCounter = document.getElementById(`counter_${i}`).checked;
            });
            localStorage.setItem('sys_config_v4', JSON.stringify(config));
            alert("設定を保存しました"); location.reload();
        }

        function resetAll() {
            if(confirm("座席と履歴をすべてリセットしますか？")){
                occupiedTables.clear(); history = [];
                localStorage.setItem('occupied', "[]"); localStorage.setItem('history', "[]");
                location.reload();
            }
        }

        function renderMap() {
            const map = document.getElementById('map');
            map.style.gridTemplateColumns = `repeat(${config.cols}, 1fr)`;
            map.innerHTML = '';
            config.tables.forEach((t, i) => {
                if(!t.active) { map.appendChild(document.createElement('div')).style.visibility = 'hidden'; return; }
                const div = document.createElement('div');
                div.className = 'table active-table' + (occupiedTables.has(i) ? ' occupied' : '') + (t.isCounter ? ' is-counter' : '');
                div.innerHTML = `<span>${t.name}</span><span style="font-size:9px">${t.seats}席</span>`;
                div.onclick = () => {
                    occupiedTables.has(i) ? occupiedTables.delete(i) : occupiedTables.add(i);
                    div.classList.toggle('occupied'); localStorage.setItem('occupied', JSON.stringify([...occupiedTables]));
                };
                map.appendChild(div);
            });
        }

        function setTheme(color) {
            themeColor = color; localStorage.setItem('themeColor', color);
            document.getElementById('uiTitle').style.color = color === '#eeeeee' ? '#fff' : color;
            const btn = document.getElementById('genBtn'); btn.style.backgroundColor = color;
            const b = parseInt(color.substring(1,3), 16) * 0.299 + parseInt(color.substring(3,5), 16) * 0.587 + parseInt(color.substring(5,7), 16) * 0.114;
            btn.style.color = b > 180 ? "#222" : "#fff";
        }

        document.getElementById('bgInput').onchange = (e) => { const r = new FileReader(); r.onload = (ev) => { userBgImage = new Image(); userBgImage.src = ev.target.result; }; r.readAsDataURL(e.target.files[0]); };
        document.getElementById('logoInput').onchange = (e) => { const r = new FileReader(); r.onload = (ev) => { logoImage = new Image(); logoImage.src = ev.target.result; localStorage.setItem('userLogo', ev.target.result); }; r.readAsDataURL(e.target.files[0]); };

function generateImage(mode) { // 引数を mode に変更
    const canvas = document.getElementById('mainCanvas'), ctx = canvas.getContext('2d');
    ctx.fillStyle = "#1a1a1a"; ctx.fillRect(0, 0, 1080, 1920);
    
    // 背景・ロゴ描画
    if (userBgImage) {
        const ca = 1080/1920, ia = userBgImage.width/userBgImage.height; let dw, dh, ox, oy;
        if (ia > ca) { dh = userBgImage.height; dw = userBgImage.height*ca; ox = (userBgImage.width-dw)/2; oy = 0; }
        else { dw = userBgImage.width; dh = userBgImage.width/ca; ox = 0; oy = (userBgImage.height-dh)/2; }
        ctx.drawImage(userBgImage, ox, oy, dw, dh, 0, 0, 1080, 1920);
        ctx.fillStyle = (mode === 'closed' || mode === 'reserved') ? "rgba(0,0,0,0.7)" : "rgba(0,0,0,0.5)"; 
        ctx.fillRect(0, 0, 1080, 1920);
    }
    if (logoImage) { const lw = 280, lh = logoImage.height*(lw/logoImage.width); ctx.drawImage(logoImage, 540-(lw/2), 150, lw, lh); }
    
    ctx.shadowBlur = 15; ctx.shadowColor = "black"; ctx.textAlign = "center";

    if (mode === 'closed') {
        // 営業終了
        ctx.fillStyle = '#fff'; ctx.font = "bold 90px sans-serif"; ctx.fillText("本日の営業は", 540, 800); ctx.fillText("終了いたしました", 540, 930);
        ctx.fillStyle = themeColor === '#eeeeee' ? '#00c853' : themeColor; ctx.font = "bold 50px sans-serif"; ctx.fillText("本日も多くのご来店ありがとうございました！", 540, 1150);
    } else if (mode === 'reserved') {
        // 貸切営業
        ctx.fillStyle = '#ffeb3b'; ctx.font = "bold 110px sans-serif"; ctx.fillText("本日は貸切営業", 540, 800);
        ctx.fillStyle = '#fff'; ctx.font = "bold 90px sans-serif"; ctx.fillText("となっております", 540, 950);
        ctx.font = "50px sans-serif"; ctx.fillText("またのご来店をお待ちしております", 540, 1150);
    } else {
        // 通常または満席スタート
        ctx.fillStyle = themeColor === '#eeeeee' ? '#fff' : themeColor; ctx.font = "bold 80px sans-serif"; ctx.fillText("本日の空席状況", 540, 480);
        
        let tRem = 0, sRem = 0, cRem = 0, hasCounter = false;
        config.tables.forEach((t, i) => { 
            if (t.active) { 
                if (t.isCounter) { hasCounter = true; if (!occupiedTables.has(i)) cRem += 1; }
                else if (!occupiedTables.has(i)) { tRem++; sRem += t.seats; } 
            } 
        });

        // 'full' モードなら強制的に満席表示にする
        let line1 = (mode === 'full' || (tRem === 0 && (!hasCounter || cRem === 0))) ? "満席御礼！" : `残り ${tRem}卓 / ${sRem}席`;
        let line2 = (mode === 'full') ? "" : (hasCounter ? `カウンター残り ${cRem}席` : "");
        
        if (history.length === 0 || history[history.length - 1] !== line1 + line2) { 
            history.push(line1 + line2); if (history.length > 5) history.shift(); // 履歴5個
            localStorage.setItem('history', JSON.stringify(history)); 
        }
        
        history.forEach((text, index) => {
            const isLast = (index === history.length - 1), y = 800 + (index * 140); // 140に短縮
            if (!isLast) {
                ctx.font = "40px sans-serif"; ctx.fillStyle = "rgba(255,255,255,0.4)";
                ctx.fillText(text.includes("カウンター") ? text.split("カウンター")[0] : text, 540, y);
                ctx.strokeStyle = "rgba(255, 0, 0, 0.5)"; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(400, y-15); ctx.lineTo(680, y-15); ctx.stroke();
            } else {
                ctx.fillStyle = "#fff";
                if (line1 === "満席御礼！") {
                    ctx.font = "bold 160px sans-serif"; ctx.fillText(line1, 540, y + 50);
                } else {
                    ctx.font = "bold 110px sans-serif"; ctx.fillText(line1, 540, y);
                    if (hasCounter && line2 !== "") {
                        ctx.font = "bold 70px sans-serif"; ctx.fillStyle = themeColor === '#eeeeee' ? '#00c853' : themeColor;
                        ctx.fillText(line2, 540, y + 100);
                    }
                }
            }
        });
    }

    // フッター描画（共通）
    const now = new Date(); const ds = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')} ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')} 現在`;
    ctx.shadowBlur = 0; ctx.font = "50px sans-serif"; ctx.fillStyle = "#ccc"; ctx.fillText(ds, 540, 1800);
    ctx.fillStyle = themeColor === '#eeeeee' ? '#00c853' : themeColor;
    let bm = (mode === 'closed' || mode === 'reserved') ? "またのご来店をお待ちしております" : ((mode === 'full') ? "お電話にて空席待ちを承ります！" : "ご来店お待ちしております！");
    ctx.fillText(bm, 540, 1700);
    ctx.font = "28px sans-serif"; ctx.fillStyle = "rgba(255,255,255,0.3)"; ctx.fillText("Powered by " + FIXED_BRAND, 540, 1880);
    
    const imgEl = document.getElementById('resultImage'); imgEl.src = canvas.toDataURL('image/png'); imgEl.style.display = 'inline-block';
    window.scrollTo({top: document.getElementById('outputArea').offsetTop, behavior: 'smooth'});
}
        const savedLogo = localStorage.getItem('userLogo'); if (savedLogo) { logoImage = new Image(); logoImage.src = savedLogo; }
        setTheme(themeColor); renderMap();
    </script>
</body>
</html>
